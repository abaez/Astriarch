<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>

  <title>mpalmerlee/Stratiscape @ GitHub</title>

  <style type="text/css">
    body {
      margin-top: 1.0em;
	  margin-bottom: 1.0em;
      background-color: #007F0E;
      font-family: "Helvetica,Arial,FreeSans";
      color: #ffffff;
    }
    #container {
      margin: 0 auto;
      width: 700px;
    }
    h1 { font-size: 3.8em; color: #3366ff; margin-bottom: 3px; }
    h1 .small { font-size: 0.4em; }
    h1 a { text-decoration: none }
    h2 { font-size: 1.5em; color: #3366ff; }
    h3 { text-align: center; color: #3366ff; }
    a { color: #3366ff; }
    .description { font-size: 1.2em; margin-bottom: 30px; margin-top: 30px; font-style: italic;}
    .download { float: right; }
    pre { background: #000; color: #fff; padding: 15px;}
    hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    .footer { text-align:center; padding-top:30px; font-style: italic; }
  </style>
  <script type="text/javascript" src="jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="js-inherit.js"></script>
<script type="text/javascript" src="jCanvas.js"></script>
<script type="text/javascript" src="pinwheel.js"></script>
<script type="text/javascript" src="dandelion-background.js"></script>
<script type="text/javascript" charset="utf-8">

function rotatePinwheel(){
	Pinwheel.rotateWheels(-5);
	document.wheelLayer.needsDisplay = true;//set dirtyflag
}

function populatePinwheels() {
	Pinwheel.populateWheels();//create our wheels
	//add the wheels to the canvas
	for(var i in Pinwheel.wheels)
	{
		document.wheelLayer.addChild(Pinwheel.wheels[i]);
	}
}

function changeWindDirection() {
	DandelionBackground.windAngle += DandelionBackground.nextRandomFloat(-5, 5);
	if(DandelionBackground.windSpeed > 2)
		DandelionBackground.windSpeed += DandelionBackground.nextRandomFloat(-0.5, 0.5);
	else
		DandelionBackground.windSpeed += DandelionBackground.nextRandomFloat(0, 2);
	
	updateWindVaneDisplay();
}

function updateWindVaneDisplay() {
	document.windVane.angle = DandelionBackground.windAngle;
	document.windVane.speed = DandelionBackground.windSpeed;
	document.bgLayer.needsDisplay = true;
	//$('#debugData').text('Wind Angle: ' + DandelionBackground.windAngle + ', Wind Speed: ' + DandelionBackground.windSpeed);
}

function moveDandelions() {
	DandelionBackground.moveDandelions();
	document.fgLayer.needsDisplay = true;//set dirtyflag
}

function populateDandelions() {
	//add the dandelions to the canvas
	for(var i in DandelionBackground.dandelions)
	{
		document.fgLayer.addChild(DandelionBackground.dandelions[i]);
	}
}


WindVane = jCanvas.DrawnObject.extend({ //vane drawn object class

	init: function(x, y, width, height, angle, speed, imageLoadedCallback) {
		this.x = x;
		this.y = y;
		this.width = width;
		this.height = height;
		
		this.angle = angle;
		this.speed = speed;
		
		this.imageVane = new Image();
		this.imageVane.onload = function() {
			imageLoadedCallback();
		};
		this.imageVane.src = "img/WindVane.png";
	},
	
	draw: function(ctx) {
		
		//draw circle:
		var controlRectWidth = this.width;
		 
		ctx.beginPath();
		ctx.arc(this.x + controlRectWidth/2,this.y + controlRectWidth/2,controlRectWidth/2,0,Math.PI*2, true);
		ctx.lineWidth=2.0;
		ctx.strokeStyle="green"; 
		ctx.stroke();	
		ctx.closePath();
		
		//draw image
		if(this.angle != 90)
		{
			ctx.save();
			ctx.translate( this.x + this.width/2, this.y + this.height/2 );
			ctx.rotate( (this.angle - 90) * DandelionBackground.degreesToRad);
			ctx.translate( -this.width/2, -this.height/2 );
			ctx.drawImage( this.imageVane, 0, 0 );
			ctx.restore();
		}
		else
			ctx.drawImage(this.imageVane, this.x, this.y);
		
		//draw text for wind direction and wind speed
		var friendlyWindSpeed = this.speed.toFixed(2);//2 decimal spaces
		var friendlyWindDirection = this.angle;
		while(friendlyWindDirection > 360)
			friendlyWindDirection -= 360;
		while(friendlyWindDirection < 0)
			friendlyWindDirection += 360;
		
		friendlyWindDirection = friendlyWindDirection.toFixed(2);//2 decimal spaces
		
		ctx.fillStyle = "green";
		ctx.font = "bold 9px sans-serif";
		ctx.textAlign = "left";
		ctx.textBalseline = 'top';
		//var textWidth = ctx.measureText(this.Planet.BoundingHex.Id);
		ctx.fillText(friendlyWindSpeed + " MPH, " + friendlyWindDirection + "°", this.x - 12, this.y + this.height + 8);
	}
});

function addWindVaneToCanvas() {
	document.bgLayer.addChild(document.windVane);
	
	changeWindDirection();
	
	setInterval('changeWindDirection()', 1000);
}

WindVaneControlButton = jCanvas.DrawnObject.extend({ //vane drawn object class
	init: function(x, y, width, height, imgSrc, imageLoadedCallback, imageClickedCallback) {
		this.x = x;
		this.y = y;
		this.width = width;
		this.height = height;
		
		this.image = new Image();
		this.image.onload = function() {
			imageLoadedCallback();
		};
		this.image.src = imgSrc;
		
		this.imageClickedCallback = imageClickedCallback;
	},
	
	draw: function(ctx) {
		ctx.drawImage(this.image, this.x, this.y);
	},
	
	isInBounds: function(x, y) {
		if( x > this.x && x < this.x + this.width &&
			y > this.y && y < this.y + this.height)
			return true;
		return false;
	},
	
	click: function() {
		this.imageClickedCallback();
	}
});

function canvasPinwheelBackgroundClicked(pos) {
	//console.log('canvas clicked ('+ pos.x +','+ pos.y +')');
	
	for(var i in document.bgLayer.children)
	{
		//TODO: provide some sort of highlight feedback on the button?
		if(document.bgLayer.children[i].isInBounds(pos.x, pos.y))
		{
			document.bgLayer.children[i].click();
		}
	}
}

function windSpeedMinusControlButtonClicked() {
	DandelionBackground.windSpeed -= 1;
	updateWindVaneDisplay();
}

function windSpeedPlusControlButtonClicked() {
	DandelionBackground.windSpeed += 1;
	updateWindVaneDisplay();
}

function windAnglePlusControlButtonClicked() {
	DandelionBackground.windAngle += 5;
	updateWindVaneDisplay();
}

function windAngleMinusControlButtonClicked() {
	DandelionBackground.windAngle -= 5;
	updateWindVaneDisplay();
}

function addWindSpeedMinusControlButtonToCanvas() {
	document.bgLayer.addChild(document.windSpeedMinusControlButton);
}

function addWindSpeedPlusControlButtonToCanvas() {
	document.bgLayer.addChild(document.windSpeedPlusControlButton);
}

function addWindAnglePlusControlButtonToCanvas() {
	document.bgLayer.addChild(document.windAnglePlusControlButton);
}

function addWindAngleMinusControlButtonToCanvas() {
	document.bgLayer.addChild(document.windAngleMinusControlButton);
}

$(document).ready(function() {
	document.jCanvasDraw = new jCanvas({'containerSelector':'#canvasContainer',
								'layers':[
									{'name':'canvasPinwheelBackground', x:0, y:0, width:640, height:480,'zIndex':1, 'backgroundColor':'black', 'clickCallback':canvasPinwheelBackgroundClicked, 'mouseHitSelector':'#canvasMouseHitDetector'},
									{'name':'canvasPinwheelWheels', x:170, y:90, width:300, height:300,'zIndex':2},
									{'name':'canvasPinwheelForeground', x:0, y:0, width:640, height:480,'zIndex':3}
								]
							});
	if(document.jCanvasDraw.canvasSupported)
	{
		document.wheelLayer = document.jCanvasDraw.getLayer('canvasPinwheelWheels');
		document.bgLayer = document.jCanvasDraw.getLayer('canvasPinwheelBackground');
		document.fgLayer = document.jCanvasDraw.getLayer('canvasPinwheelForeground');
		
		document.windVane = new WindVane(571,5, 64, 64, 90, 0, addWindVaneToCanvas);
		
		document.windSpeedMinusControlButton = new WindVaneControlButton(571, 82, 16, 16, "img/WindSpeedButtonMinus.png", addWindSpeedMinusControlButtonToCanvas, windSpeedMinusControlButtonClicked);
		document.windSpeedPlusControlButton = new WindVaneControlButton(619, 82, 16, 16, "img/WindSpeedButtonPlus.png", addWindSpeedPlusControlButtonToCanvas, windSpeedPlusControlButtonClicked);
		document.windAnglePlusControlButton = new WindVaneControlButton(550, 5, 16, 16, "img/WindAngleButtonPlus.png", addWindAnglePlusControlButtonToCanvas, windAnglePlusControlButtonClicked);
		document.windAngleMinusControlButton = new WindVaneControlButton(550, 53, 16, 16, "img/WindAngleButtonMinus.png", addWindAngleMinusControlButtonToCanvas, windAngleMinusControlButtonClicked);
		
		DandelionBackground.populateDandelions(160, populateDandelions);//create our background dandelions
		
		Pinwheel.init(populatePinwheels);
		
		setInterval('document.jCanvasDraw.draw()', 50);
		
		setInterval('rotatePinwheel()', 100);
		
		setInterval('moveDandelions()', 33);
	} else {
		$('#canvasContainer').html('<p style="color:red">Bummer! Your browser does not support the HTML 5 Canvas Tag!</p>');
	}
	
});
</script>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-7797548-3']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>
<body>
  <a href="http://github.com/mpalmerlee/Stratiscape"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" /></a>

  <div id="container">

    <div class="download">
      <a href="http://github.com/mpalmerlee/Stratiscape/zipball/master">
        <img border="0" width="90" src="http://github.com/images/modules/download/zip.png"></a>
      <a href="http://github.com/mpalmerlee/Stratiscape/tarball/master">
        <img border="0" width="90" src="http://github.com/images/modules/download/tar.png"></a>
    </div>

    <h1><a href="http://github.com/mpalmerlee/Stratiscape">Stratiscape</a>
      <span class="small">by <a href="http://github.com/mpalmerlee">mpalmerlee</a></span></h1>

    <div class="description">
      Simple HTML5 Canvas library supporting multiple layers and a drawn object model.  Currently Strariscape is in Pre-Alpha stages, working on examples and documentation, will also change change the main object name from jCanvas to Stratiscape.
    </div>

    <p>Stratiscape - Multi-Layer Javascript Canvas Library</p><h2>Dependencies</h2>
<p>jQuery and John Resig's Simple JavaScript Inheritance library</p>
<h2>License</h2>
<p>MIT License</p>
<h2>Authors</h2>
<p>Matt Palmerlee<br/>
<br/>      </p>



    <h2>Download</h2>
    <p>
      You can download this project in either
      <a href="http://github.com/mpalmerlee/Stratiscape/zipball/master">zip</a> or
      <a href="http://github.com/mpalmerlee/Stratiscape/tarball/master">tar</a> formats.
    </p>
    <p>You can also clone the project with <a href="http://git-scm.com">Git</a>
      by running:
      <pre>$ git clone git://github.com/mpalmerlee/Stratiscape</pre>
    </p>

    <div class="footer">
      get the source code on GitHub : <a href="http://github.com/mpalmerlee/Stratiscape">mpalmerlee/Stratiscape</a>
    </div>

  
	<br />
	<h2>Example Built using Stratiscape:</h2>
	<p>Pinwheel and Dandelions:<br/>      </p>

	<div>

	<div id="canvasContainer" style="position: relative;"></div>
	<div id="canvasMouseHitDetector" style="position: relative;width:640px;height:480px;z-Index:20;"></div>
	
	<p> Example of multiple layers drawn independently and mouse interaction. More examples to come. <p/>
	</div>
	
  <br />
  <br />
</div>

</body>
</html>
